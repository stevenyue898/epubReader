<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foliate È£éÊ†º EPUB ÈòÖËØªÂô® (V0.8 Á≤æÂáÜÂà§ÂÆöÁâà)</title>
    <!-- ËØ∑Á°Æ‰øùÊú¨Âú∞Êúâ jszip.min.js Âíå epub.min.js -->
    <script src="jszip.min.js"></script>
    <script src="epub.min.js"></script>
    
    <style>
        :root {
            --bg-paper: #fbf8f3;
            --bg-sidebar: #f5f0e8;
            --text-primary: #2d2d2d;
            --text-secondary: #666666;
            --accent: #c8a47e;
            --border: #e0d8d0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft Yahei','Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif,'Ê±áÊñáÊòéÊúù‰Ωì';
            background: var(--bg-paper);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .navbar {
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-subtle);
            position: relative;
            z-index: 100;
            height: 60px;
            flex-shrink: 0;
        }

        .nav-left, .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-btn {
            background: transparent;
            border: 1px solid transparent;
            padding: 8px 12px;
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            z-index: 101;
        }

        .nav-btn:hover { background: rgba(200, 164, 126, 0.1); }

        .book-title {
            font-size: 16px;
            font-weight: 500;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ‰∏ªÂÜÖÂÆπÂå∫ */
        .main-container {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        /* ‰æßËæπÊ†è */
        .sidebar {
            width: 320px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 150;
            box-shadow: var(--shadow);
        }

        .sidebar.open { transform: translateX(0); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); font-weight: 600; font-size: 16px; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 12px 0; }
        .toc-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            border-left: 3px solid transparent;
        }
        .toc-item:hover { background: rgba(200, 164, 126, 0.1); }
        .toc-item.current { border-left-color: var(--accent); background: rgba(200, 164, 126, 0.15); font-weight: 500; }

        /* ÈòÖËØªÂå∫Âüü */
        .reading-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--bg-paper);
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        #viewer {
            flex: 1;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* Ê≥®ÈáäÂºπÁ™óÊ†∑Âºè */
        .annotation-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 600;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        .annotation-modal-overlay.active { display: flex; animation: fadeIn 0.2s; }

        .annotation-modal {
            background: white;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .annotation-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fcfcfc;
        }

        .annotation-title { font-weight: 600; font-size: 16px; color: var(--text-primary); }
        .annotation-close {
            background: none; border: none; font-size: 20px; cursor: pointer; color: #999;
            padding: 0 5px; transition: color 0.2s;
        }
        .annotation-close:hover { color: var(--accent); }

        .annotation-content {
            padding: 20px;
            overflow-y: auto;
            line-height: 1.6;
            color: #333;
            font-size: 15px;
        }

        /* ËÆæÁΩÆÈù¢Êùø */
        .settings-panel {
            position: absolute;
            top: 16px;
            right: 16px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            width: 320px;
            display: none;
            z-index: 200;
            border: 1px solid var(--border);
        }

        .settings-panel.active { display: block; animation: slideIn 0.2s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .settings-section { margin-bottom: 20px; }
        .settings-section:last-child { margin-bottom: 0; }
        .settings-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: block;
        }
        .settings-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .option-btn {
            background: var(--bg-sidebar);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .option-btn:hover { border-color: var(--accent); }
        .option-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .font-size-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-sidebar);
            border-radius: 6px;
            padding: 4px;
        }
        .font-size-btn {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border: none; background: transparent; cursor: pointer;
            border-radius: 4px; font-size: 18px;
        }
        .font-size-btn:hover { background: rgba(200, 164, 126, 0.2); }
        .font-size-display { font-size: 14px; font-weight: 500; min-width: 60px; text-align: center; }

        select.font-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-sidebar);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 14px;
        }
        select.font-select:focus { outline: none; border-color: var(--accent); background-color: white; }

        /* Êñá‰ª∂‰∏ä‰º†ÁïåÈù¢ */
        .upload-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-paper);
            display: flex;
            align-items: center; justify-content: center;
            z-index: 300;
        }
        .upload-container.hidden { display: none; }
        .upload-box {
            background: white;
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 2px dashed var(--border);
            cursor: pointer;
            transition: all 0.3s;
            max-width: 500px; width: 90%;
        }
        .upload-box:hover { border-color: var(--accent); transform: translateY(-4px); }

        /* ÂØºËà™ÁÆ≠Â§¥ */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 44px; height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255, 0.9);
            border: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-subtle);
            transition: all 0.2s;
            opacity: 0.3;
            z-index: 50;
            color: var(--text-primary);
        }
        .nav-arrow:hover {
            opacity: 1;
            background: white;
            transform: translateY(-50%) scale(1.1);
            border-color: var(--accent);
            color: var(--accent);
        }
        #prev-page { left: 24px; }
        #next-page { right: 24px; }

        /* ËøõÂ∫¶Êù° */
        .progress-container {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 6px;
            background: rgba(0, 0, 0, 0.05);
            cursor: pointer;
            z-index: 50;
            transition: height 0.2s;
        }
        .progress-container:hover { height: 10px; }
        .progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.1s;
        }
        .progress-handle {
            position: absolute;
            top: 50%;
            right: -8px;
            transform: translateY(-50%);
            width: 16px; height: 16px;
            background: white;
            border: 2px solid var(--accent);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .progress-container:hover .progress-handle { opacity: 1; }

        @media (max-width: 768px) {
            .sidebar { width: 85%; z-index: 250; }
            .settings-panel { width: 85%; right: 7.5%; z-index: 260; }
            .nav-arrow { width: 36px; height: 36px; opacity: 0.1; }
            .book-title { display: none; }
            .annotation-modal { width: 95%; }
        }

        #toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 500;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        #toast.show { opacity: 1; }

        #error-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <!-- ÈîôËØØÊèêÁ§∫ -->
    <div id="error-toast"></div>
    <!-- ÈÄöÁî®ÊèêÁ§∫ -->
    <div id="toast"></div>

    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <nav class="navbar">
        <div class="nav-left">
            <button class="nav-btn" id="sidebar-toggle" title="ÁõÆÂΩï">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                ÁõÆÂΩï
            </button>
            <span class="book-title" id="book-title">Êú™ÊâìÂºÄ‰π¶Á±ç</span>
        </div>
        
        <div class="nav-right">
            <button class="nav-btn" id="settings-toggle">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                ËÆæÁΩÆ
            </button>
            <button class="nav-btn" id="new-book-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                ÊâìÂºÄ
            </button>
        </div>
    </nav>

    <!-- ‰∏ªÂÆπÂô® -->
    <div class="main-container">
        <!-- ‰æßËæπÊ†è -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">ÁõÆÂΩï</div>
            <div class="sidebar-content" id="toc-content"></div>
        </aside>

        <!-- ÈòÖËØªÂå∫Âüü -->
        <div class="reading-area">
            <div id="viewer"></div>
            
            <button class="nav-arrow" id="prev-page" title="‰∏ä‰∏ÄÈ°µ">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <button class="nav-arrow" id="next-page" title="‰∏ã‰∏ÄÈ°µ">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>
            
            <div class="progress-container" id="progress-container" title="ÁÇπÂáªË∑≥ËΩ¨">
                <div class="progress-bar" id="progress-bar">
                    <div class="progress-handle"></div>
                </div>
            </div>
            
            <div class="upload-container" id="upload-container">
                <div class="upload-box" id="upload-box">
                    <div class="upload-icon" style="font-size: 64px; margin-bottom: 24px;">üìö</div>
                    <h2 class="upload-title" style="font-size: 24px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">ÊâìÂºÄ EPUB Êñá‰ª∂</h2>
                    <p class="upload-subtitle" style="color: var(--text-secondary); font-size: 14px;">ÁÇπÂáªÊàñÊãñÊãΩÊñá‰ª∂Âà∞ËøôÈáå</p>
                    <input type="file" id="file-input" accept=".epub" style="display: none;">
                </div>
            </div>
        </div>

        <!-- ËÆæÁΩÆÈù¢Êùø -->
        <div class="settings-panel" id="settings-panel">
            <div class="settings-section">
                <div class="settings-label">ÊòæÁ§∫Ê®°Âºè</div>
                <div class="settings-options">
                    <button class="option-btn active" data-view="double">ÂèåÈ°µ</button>
                    <button class="option-btn" data-view="single">ÂçïÈ°µ</button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-label">Â≠ó‰ΩìÂ§ßÂ∞è</div>
                <div class="font-size-controls">
                    <button class="font-size-btn" id="font-decrease">-</button>
                    <span class="font-size-display" id="font-size">120%</span>
                    <button class="font-size-btn" id="font-increase">+</button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-label">Â≠ó‰ΩìÈÄâÊã©</div>
                <select id="font-family-select" class="font-select">
                    <option value="'Literata', 'Source Han Serif SC', 'Noto Serif SC', 'Songti SC' ,serif">Á≥ªÁªüÈªòËÆ§Ë°¨Á∫ø‰Ωì (Êé®Ëçê)</option>
                    <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei','ÂçéÊñá‰∏≠ÂÆã', sans-serif">Á≥ªÁªüÈªòËÆ§Êó†Ë°¨Á∫ø‰Ωì</option>
                    <option value="'Huiwen-mincho','Huiwen Mincho','Ê±áÊñáÊòéÊúù‰Ωì'">Ê±áÊñáÊòéÊúù‰Ωì</option>
                    <option value="'Microsoft YaHei', 'PingFang SC', 'Heiti SC',  'WenQuanYi Micro Hei',sans-serif">Èªë‰Ωì</option>
                    <option value="'KaiTi', 'STKaiti', serif">Ê•∑‰Ωì</option>
                    <option value="'Georgia', serif">Georgia (Ëã±ÊñáË°¨Á∫ø)</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                    <option value="'Arial', sans-serif">Arial</option>
                    <option value="'Verdana', sans-serif">Verdana</option>
                    <option value="'Courier New', monospace">Courier New (Á≠âÂÆΩ)</option>
                </select>
            </div>
            
            <div class="settings-section">
                <div class="settings-label">‰∏ªÈ¢ò</div>
                <div class="settings-options">
                     <button class="option-btn active" data-theme="white">Áº∫ÁúÅÔºàÁôΩËâ≤Ôºâ</button>
                    <button class="option-btn" data-theme="light">ÊµÖËâ≤</button>
                    <button class="option-btn" data-theme="sepia">ÁæäÁöÆÁ∫∏</button>
                    <button class="option-btn" data-theme="dark">Ê∑±Ëâ≤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê≥®ÈáäÂºπÁ™ó -->
    <div class="annotation-modal-overlay" id="annotation-modal">
        <div class="annotation-modal">
            <div class="annotation-header">
                <span class="annotation-title">Ê≥®ÈáäÂÜÖÂÆπ</span>
                <button class="annotation-close" id="annotation-close">&times;</button>
            </div>
            <div class="annotation-content" id="annotation-content">
                <!-- Âä®ÊÄÅÂÜÖÂÆπ -->
            </div>
        </div>
    </div>

    <script>
        class FoliateReader {
            constructor() {
                this.book = null;
                this.rendition = null;
                this.currentFontSize = 120;
                this.currentFont = "'Literata', 'Source Han Serif SC', 'Noto Serif SC',  'ÂçéÊñá‰∏≠ÂÆã','Songti SC', serif";
                this.currentTheme = 'white';
                this.currentView = 'double';
                this.locationsReady = false;
                this.lastWheelTime = 0;
                this.wheelDelay = 300;
                
                // Ê≥®ÈáäÈ¢ÑËßàÁõ∏ÂÖ≥Áä∂ÊÄÅ
                this.isPreviewingLink = false;
                this.previousCfi = null;
                
                this.themes = {
                    white: { body: { background: '#ffffff', color: '#000000' } },
                    light: { body: { background: '#fbf8f3', color: '#2d2d2d' } },
                    sepia: { body: { background: '#f5e6d3', color: '#5b4636' } },
                    dark: { body: { background: '#1a1a1a', color: '#e0e0e0' } }
                };
                
                this.init();
            }
            
            init() {
                this.cacheDOM();
                this.bindEvents();
            }
            
            cacheDOM() {
                this.dom = {
                    fileInput: document.getElementById('file-input'),
                    uploadContainer: document.getElementById('upload-container'),
                    uploadBox: document.getElementById('upload-box'),
                    viewer: document.getElementById('viewer'),
                    sidebar: document.getElementById('sidebar'),
                    tocContent: document.getElementById('toc-content'),
                    settingsPanel: document.getElementById('settings-panel'),
                    bookTitle: document.getElementById('book-title'),
                    progressBar: document.getElementById('progress-bar'),
                    progressContainer: document.getElementById('progress-container'),
                    fontSize: document.getElementById('font-size'),
                    fontSelect: document.getElementById('font-family-select'),
                    errorToast: document.getElementById('error-toast'),
                    toast: document.getElementById('toast'),
                    annotationModal: document.getElementById('annotation-modal'),
                    annotationContent: document.getElementById('annotation-content'),
                    annotationClose: document.getElementById('annotation-close')
                };
            }
            
            bindEvents() {
                // Êñá‰ª∂‰∏ä‰º†
                this.dom.uploadBox.addEventListener('click', () => this.dom.fileInput.click());
                this.dom.fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));
                this.dom.uploadBox.addEventListener('dragover', (e) => { e.preventDefault(); this.dom.uploadBox.style.borderColor = 'var(--accent)'; });
                this.dom.uploadBox.addEventListener('dragleave', (e) => { e.preventDefault(); this.dom.uploadBox.style.borderColor = 'var(--border)'; });
                this.dom.uploadBox.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.dom.uploadBox.style.borderColor = 'var(--border)';
                    if (e.dataTransfer.files.length > 0) this.handleFile(e.dataTransfer.files[0]);
                });
                
                // ÂØºËà™ÊéßÂà∂
                document.getElementById('sidebar-toggle').addEventListener('click', () => this.toggleSidebar());
                document.getElementById('settings-toggle').addEventListener('click', () => this.toggleSettings());
                document.getElementById('new-book-btn').addEventListener('click', () => this.openNewBook());
                
                // ÊåâÈíÆÁøªÈ°µ
                document.getElementById('prev-page').addEventListener('click', () => this.prevPage());
                document.getElementById('next-page').addEventListener('click', () => this.nextPage());
                
                // ÊªöËΩÆÁøªÈ°µ
                this.dom.viewer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const now = Date.now();
                    if (now - this.lastWheelTime > this.wheelDelay) {
                        if (e.deltaY > 0) this.nextPage();
                        else this.prevPage();
                        this.lastWheelTime = now;
                    }
                }, { passive: false });

                // ÈîÆÁõò
                document.addEventListener('keyup', (e) => {
                    if (e.key === 'ArrowLeft') this.prevPage();
                    if (e.key === 'ArrowRight') this.nextPage();
                    if (e.key === 'Escape') {
                        this.closePanels();
                        this.closeAnnotationModal();
                    }
                });

                // ËÆæÁΩÆÊéßÂà∂
                document.getElementById('font-increase').addEventListener('click', () => this.adjustFontSize(5));
                document.getElementById('font-decrease').addEventListener('click', () => this.adjustFontSize(-5));
                
                // Â≠ó‰Ωì‰∏ãÊãâÊ°Ü
                this.dom.fontSelect.addEventListener('change', (e) => {
                    this.setFont(e.target.value);
                });
                
                document.querySelectorAll('[data-view]').forEach(btn => {
                    btn.addEventListener('click', (e) => this.setViewMode(e.target.dataset.view));
                });
                
                document.querySelectorAll('[data-theme]').forEach(btn => {
                    btn.addEventListener('click', (e) => this.setTheme(e.target.dataset.theme));
                });
                
                // ËøõÂ∫¶Êù°ÁÇπÂáª
                this.dom.progressContainer.addEventListener('click', (e) => this.handleProgressClick(e));

                // ÂÖ≥Èó≠ÂºπÁ™ó
                this.dom.annotationClose.addEventListener('click', () => this.closeAnnotationModal());
                this.dom.annotationModal.addEventListener('click', (e) => {
                    if(e.target === this.dom.annotationModal) this.closeAnnotationModal();
                });
            }
            
            showToast(msg) {
                this.dom.toast.textContent = msg;
                this.dom.toast.classList.add('show');
                setTimeout(() => this.dom.toast.classList.remove('show'), 2000);
            }

            showError(msg) {
                this.dom.errorToast.textContent = msg;
                this.dom.errorToast.style.display = 'block';
                setTimeout(() => this.dom.errorToast.style.display = 'none', 3000);
            }

            // Ê†∏ÂøÉ‰ºòÂåñÔºöÊõ¥Á≤æÂáÜÁöÑÂà§ÂÆöÈÄªËæë
            isAnnotationLink(url) {
                if (!url) return false;
                const lowerUrl = url.toLowerCase();
                const fragment = url.split('#')[1] || "";
                const path = url.split('#')[0];

                // 1. ÊòéÁ°ÆÊéíÈô§ÔºöÁ´†ËäÇ/È°µÈù¢ÁªìÊûÑÁ±ªÈìæÊé• (Ëøô‰∫õÂ∫îËØ•Áõ¥Êé•Ë∑≥ËΩ¨Ôºå‰∏çÂºπÁ™ó)
                // Ê∂µÁõñÔºöÂèÇËÄÉÊñáÁåÆ, ÁõÆÂΩï, Á¥¢Âºï, Â∫èË®Ä, ÈôÑÂΩïÁ≠â
                const chapterPatterns = [
                    /#reference(s)?(#|$)/,  // #reference Êàñ #references
                    /#bibliography/i,
                    /#index/i,
                    /#preface/i,
                    /#contents/i,
                    /#glossary/i,
                    /#appendix/i,
                    /#titlepage/i,
                    /#toc/i,             // ÁõÆÂΩïÈ°µÊú¨Ë∫´
                    /chapter/i,          // ÂåÖÂê´ chapter ÁöÑÈìæÊé•
                    /section/i           // ÂåÖÂê´ section ÁöÑÈìæÊé•
                ];

                if (chapterPatterns.some(regex => regex.test(url))) {
                    return false;
                }

                // 2. ÂåπÈÖçËÑöÊ≥®ÔºöÂè™ÊúâÊòéÁ°ÆÂåÖÂê´Êï∞Â≠óÁöÑÊâçÂà§ÂÆö‰∏∫Ê≥®Èáä
                // ÊØîÂ¶Ç #fn1, #footnote-1, #note-1, #ref-1 (‰ΩÜ #reference ‰∏çÂåπÈÖç)
                const strictFootnotePatterns = [
                    /footnote[-_]?\d/,    // #footnote1 Êàñ #footnote-1
                    /endnote[-_]?\d/,
                    /fn[-_]?\d/,          // #fn1 Êàñ #fn-1
                    /note[-_]?\d/,
                    /cite[-_]?\d/,
                    /ref[-_]?\d/          // #ref-1 ÊòØÂºïÁî®, #reference ÊòØÁ´†ËäÇ
                ];

                if (strictFootnotePatterns.some(regex => regex.test(lowerUrl))) {
                    return true;
                }

                return false;
            }

            // Ê†∏ÂøÉÂäüËÉΩÔºö‰øÆÂ§çÂπ∂Êã¶Êà™ Iframe ÂÜÖÁöÑÈìæÊé•
            fixAndInterceptLinks(contents) {
                const links = contents.document.querySelectorAll('a[href]');
                links.forEach(link => {
                    let href = link.getAttribute('href');
                    if (!href) return;

                    // Â¶ÇÊûúÊòØÁªùÂØπË∑ØÂæÑ
                    if (href.startsWith('file://') || (href.startsWith('/') && !href.startsWith('//'))) {
                        const resolved = this.resolveUrl(href);
                        if (resolved && resolved !== href) {
                            link.setAttribute('href', resolved);
                        }
                    }
                });

                // Êã¶Êà™ÁÇπÂáª‰∫ã‰ª∂
                contents.document.addEventListener('click', (e) => {
                    const target = e.target.closest('a');
                    if (!target) return;

                    e.preventDefault();
                    e.stopPropagation();

                    const href = target.getAttribute('href');
                    console.log("[Click Intercepted]", href);

                    // Â§ñÈÉ®ÈìæÊé•
                    if (href.startsWith('http://') || href.startsWith('https://')) {
                        window.open(href, '_blank');
                        return;
                    }

                    // ÂÜÖÈÉ®ÈìæÊé• -> ‰º†ÈÄíÁªôÊàë‰ª¨ÁöÑÂ§ÑÁêÜÁ®ãÂ∫è
                    this.handleLinkClick(href);
                }, true); 
            }
            
            async handleFile(file) {
                if (!file || !file.name.endsWith('.epub')) {
                    this.showError('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑ EPUB Êñá‰ª∂');
                    return;
                }
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    this.loadBook(arrayBuffer, file.name);
                } catch (error) {
                    console.error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•:', error);
                    this.showError('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            }
            
            loadBook(bookData, fileName) {
                if (this.book) this.book.destroy();
                
                this.book = ePub(bookData);
                this.locationsReady = false;
                
                this.book.ready.then(() => {
                    this.book.loaded.metadata.then(metadata => {
                        this.dom.bookTitle.textContent = metadata.title || fileName.replace('.epub', '');
                    });
                });
                
                const spreadMode = this.currentView === 'double' ? 'always' : 'none';
                
                this.rendition = this.book.renderTo(this.dom.viewer, {
                    width: '100%',
                    height: '100%',
                    spread: spreadMode,
                    flow: 'paginated'
                });
                
                this.rendition.on('linkClicked', (url) => this.handleLinkClick(url));
                
                this.rendition.display().then(() => {
                    this.rendition.resize();
                    this.forceApplyFont(); 
                    this.showToast("Â∑≤Âä†ËΩΩ");
                });
                
                this.registerThemes();
                this.rendition.themes.select(this.currentTheme);
                this.rendition.themes.fontSize(`${this.currentFontSize}%`);
                
                this.rendition.on("rendered", (section) => {
                    this.forceApplyFont();
                    this.rendition.resize();
                    
                    const contents = this.rendition.getContents();
                    contents.forEach(c => this.fixAndInterceptLinks(c));

                    if (this.isPreviewingLink) {
                        setTimeout(() => this.showAnnotationModalFromIframe(), 50);
                    }
                });
                
                this.book.loaded.navigation.then(navigation => {
                    this.generateTOC(navigation.toc);
                });
                
                this.book.ready.then(() => {
                    this.book.locations.generate(1000).then(() => {
                        this.locationsReady = true;
                        console.log("Locations generated");
                    });
                });
                
                this.rendition.on('relocated', (location) => {
                    this.updateProgress(location);
                });
                
                this.dom.uploadContainer.classList.add('hidden');
            }

            resolveUrl(url) {
                if (!url) return url;
                if (!url.startsWith('/') && !url.startsWith('file://') && !url.includes('://')) {
                    return url;
                }

                try {
                    const u = new URL(url);
                    const hash = u.hash || '';
                    const fullpath = u.pathname;
                    if (!this.book || !this.book.spine) return url;

                    const spineItems = this.book.spine.get();
                    let matchedItem = null;
                    let maxLen = 0;

                    for (let item of spineItems) {
                        const itemUrl = item.url || item.href || "";
                        if (itemUrl && fullpath.endsWith(itemUrl)) {
                            if (itemUrl.length > maxLen) {
                                maxLen = itemUrl.length;
                                matchedItem = item;
                            }
                        }
                    }

                    if (matchedItem) {
                        const basePath = matchedItem.url || matchedItem.href;
                        return basePath + hash;
                    }

                    const filename = fullpath.split('/').pop();
                    for (let item of spineItems) {
                        const itemUrl = item.url || item.href || "";
                        if (itemUrl.endsWith(filename)) {
                            return itemUrl + hash;
                        }
                    }
                } catch (e) {
                    console.warn("URL parsing failed", e);
                }
                return url;
            }
            
            handleLinkClick(url) {
                const isAnnotation = this.isAnnotationLink(url);

                if (!isAnnotation) {
                    console.log("Normal Link Jump (No modal):", url);
                    this.rendition.display(url).catch(err => this.showToast("Ë∑≥ËΩ¨Â§±Ë¥•"));
                    return;
                }

                console.log("Annotation Link (Modal mode):", url);

                const currentLoc = this.rendition.currentLocation();
                if (currentLoc && currentLoc.start.cfi) {
                    this.previousCfi = currentLoc.start.cfi;
                } else {
                    this.previousCfi = null;
                    this.rendition.display(url).catch(err => this.showToast("Ë∑≥ËΩ¨Â§±Ë¥•"));
                    return;
                }

                this.isPreviewingLink = true;
                this.rendition.display(url).catch(err => {
                    console.error("Link display error", err);
                    this.showToast("Êó†Ê≥ïË∑≥ËΩ¨Âà∞ËØ•Ê≥®Èáä");
                    this.isPreviewingLink = false;
                });
            }

            showAnnotationModalFromIframe() {
                const contents = this.rendition.getContents();
                if (contents && contents.length > 0) {
                    const bodyText = contents[0].document.body.innerText;
                    const cleanText = bodyText.replace(/\n\s*\n/g, '\n').trim();
                    
                    if (cleanText) {
                        this.dom.annotationContent.textContent = cleanText;
                        this.dom.annotationModal.classList.add('active');
                    }
                }
                
                if (this.previousCfi) {
                    this.isPreviewingLink = false;
                    this.rendition.display(this.previousCfi);
                }
            }

            closeAnnotationModal() {
                this.dom.annotationModal.classList.remove('active');
            }
            
            generateTOC(toc) {
                this.dom.tocContent.innerHTML = '';
                const createTOCItem = (item, level = 0) => {
                    const div = document.createElement('div');
                    div.className = 'toc-item';
                    div.style.paddingLeft = `${20 + level * 15}px`;
                    div.textContent = item.label;
                    div.addEventListener('click', () => {
                        const targetHref = this.resolveUrl(item.href);
                        if (targetHref) {
                            this.rendition.display(targetHref).catch(err => {
                                console.error("ÁõÆÂΩïË∑≥ËΩ¨Â§±Ë¥•:", err);
                                this.showToast("Ë∑≥ËΩ¨Â§±Ë¥•ÔºåËØ∑ÈáçËØï");
                            });
                            this.dom.sidebar.classList.remove('open');
                        }
                    });
                    this.dom.tocContent.appendChild(div);
                    if (item.subitems && item.subitems.length > 0) {
                        item.subitems.forEach(subitem => createTOCItem(subitem, level + 1));
                    }
                };
                toc.forEach(item => createTOCItem(item));
            }
            
            registerThemes() {
                Object.keys(this.themes).forEach(themeName => {
                    this.rendition.themes.register(themeName, this.themes[themeName]);
                });
            }
            
            setViewMode(mode) {
                if (this.currentView === mode || !this.rendition) return;
                
                this.currentView = mode;
                document.querySelectorAll('[data-view]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === mode);
                });
                
                const currentLocation = this.rendition.currentLocation();
                
                this.rendition.destroy();
                
                const spread = mode === 'double' ? 'always' : 'none';
                
                this.rendition = this.book.renderTo(this.dom.viewer, {
                    width: '100%',
                    height: '100%',
                    spread: spread,
                    flow: 'paginated'
                });
                
                this.rendition.on('linkClicked', (url) => this.handleLinkClick(url));

                this.registerThemes();
                this.rendition.themes.select(this.currentTheme);
                this.rendition.themes.fontSize(`${this.currentFontSize}%`);
                
                this.rendition.display().then(() => {
                    this.forceApplyFont();
                    const contents = this.rendition.getContents();
                    contents.forEach(c => this.fixAndInterceptLinks(c));
                });
                
                if (currentLocation && currentLocation.start.cfi) {
                    this.rendition.display(currentLocation.start.cfi).catch(() => this.rendition.display());
                } else {
                    this.rendition.display();
                }
                
                setTimeout(() => this.rendition.resize(), 100);
            }
            
            forceApplyFont() {
                if (!this.rendition) return;
                this.rendition.getContents().forEach(contents => {
                    let style = contents.document.getElementById('custom-font-style');
                    if (!style) {
                        style = contents.document.createElement('style');
                        style.id = 'custom-font-style';
                        contents.document.head.appendChild(style);
                    }
                    style.innerHTML = `body { font-family: ${this.currentFont} !important; }`;
                });
            }
            
            setFont(fontFamily) {
                this.currentFont = fontFamily;
                if (this.rendition) {
                    this.forceApplyFont();
                }
            }
            
            setTheme(theme) {
                this.currentTheme = theme;
                document.querySelectorAll('[data-theme]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === theme);
                });
                
                if (this.rendition) {
                    this.rendition.themes.select(theme);
                    setTimeout(() => {
                        this.rendition.resize();
                        this.forceApplyFont(); 
                    }, 50);
                }
            }
            
            adjustFontSize(delta) {
                this.currentFontSize = Math.max(50, Math.min(200, this.currentFontSize + delta));
                this.dom.fontSize.textContent = `${this.currentFontSize}%`;
                if (this.rendition) {
                    this.rendition.themes.fontSize(`${this.currentFontSize}%`);
                    this.rendition.resize();
                }
            }
            
            updateProgress(location) {
                if (!location.start.percentage) return;
                const percentage = Math.round(location.start.percentage * 100);
                this.dom.progressBar.style.width = `${percentage}%`;
            }
            
            handleProgressClick(event) {
                if (!this.book) return;
                if (!this.locationsReady) {
                    this.showToast('Ê≠£Âú®ÂÆö‰Ωç‰ΩçÁΩÆÔºåËØ∑Á®çÂÄô...');
                    return;
                }
                const rect = this.dom.progressContainer.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const percentage = clickX / rect.width;
                const cfi = this.book.locations.cfiFromPercentage(percentage);
                if (cfi) {
                    this.rendition.display(cfi);
                }
            }
            
            prevPage() {
                if (this.rendition) this.rendition.prev();
            }
            
            nextPage() {
                if (this.rendition) this.rendition.next();
            }
            
            toggleSidebar() {
                this.dom.sidebar.classList.toggle('open');
                this.dom.settingsPanel.classList.remove('active');
            }
            
            toggleSettings() {
                this.dom.settingsPanel.classList.toggle('active');
                this.dom.sidebar.classList.remove('active');
            }
            
            closePanels() {
                this.dom.sidebar.classList.remove('open');
                this.dom.settingsPanel.classList.remove('active');
            }
            
            openNewBook() {
                this.dom.uploadContainer.classList.remove('hidden');
                this.dom.fileInput.value = '';
                this.closePanels();
            }
        }
        
        const reader = new FoliateReader();
    </script>
</body>
</html>
